
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>BASTOS - Editor & Viewer</title>
    <link rel="stylesheet" href="css/minitel-keyboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css" />
	<meta name="author" content="Alain Basty" />
    <meta name="keywords" content="minitel, vintage, technologie, videotex, basic, programmation" />
    <meta name="description" content="DÃ©veloppez des applications BASTOS (Basic) pour Minitel" />

    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .navbar {
        background-color: #333;
        padding: 0;
        display: flex;
        align-items: center;
        height: 50px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        display: block;
        transition: background-color 0.3s;
        cursor: pointer;
        user-select: none;
      }
      .navbar a:hover {
        background-color: #555;
      }
      .navbar a.active {
        background-color: #4CAF50;
      }
      .container {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 10px;
        gap: 10px;
      }
      .tab-content {
        flex: 1;
        display: none;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }
      .tab-content.active {
        display: flex;
      }
      .minitel-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .code-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        height: 100%;
      }
      .bottombar {
        background-color: #333;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .bottombar label {
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        white-space: nowrap;
      }
      .bottombar input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        min-width: 150px;
      }
      .bottombar button {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .bottombar button:hover {
        background-color: #45a049;
      }
      #code-editor {
        flex: 1;
        height: 100%;
      }
      .CodeMirror {
        height: 100% !important;
        width: 100% !important;
      }
    </style>
  </head>
  <body>

    <div class="navbar">
      <a id="minitel-tab" class="active">Minitel Viewer</a>
      <a id="editor-tab">Code Editor</a>
    </div>

    <div class="container">
      <!-- Minitel Viewer Tab -->
      <div id="minitel-view" class="tab-content active">
        <div class="minitel-wrapper">
          <x-minitel data-socket="ws://localhost:1967" data-speed="4800" data-color="false">
        <canvas class="minitel-screen" data-minitel="screen"></canvas>
        <canvas class="minitel-cursor" data-minitel="cursor"></canvas>
        <import src="import/minitel-keyboard.html"></import>
        <font  style="font-size:14px;color:White;font-family:Arial,Helvetica">
        <code>Connected to BASTOS</code>
        </font>
        <audio class="minitel-beep" data-minitel="beep">
            <source src="sound/minitel-bip.mp3" type="audio/mpeg"/>
            Too bad, your browser does not support HTML5 audio or mp3 format.
        </audio>
      </x-minitel>
        </div>
      </div>

      <!-- Code Editor Tab -->
      <div id="editor-view" class="tab-content">
        <div class="code-section">
          <div id="code-editor"></div>
        </div>
        <div class="bottombar">
          <label for="filename">Filename:</label>
          <input type="text" id="filename" value="edit.bas" />
          <button id="upload-btn">Upload</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/basic/basic.min.js"></script>
    <script src="library/generichelper/generichelper.js"></script>
    <script src="library/import-html/import-html.js"></script>
    <script src="library/autocallback/autocallback.js"></script>
    <script src="library/query-parameters/query-parameters.js"></script>
    <script src="library/finite-stack/finite-stack.js"></script>
    <script src="library/key-simulator/key-simulator.js"></script>
    <script src="library/settings-suite/settings-suite.js"></script>
    <script src="library/minitel/constant.js"></script>
    <script src="library/minitel/protocol.js"></script>
    <script src="library/minitel/elements.js"></script>
    <script src="library/minitel/text-grid.js"></script>
    <script src="library/minitel/char-size.js"></script>
    <script src="library/minitel/font-sprite.js"></script>
    <script src="library/minitel/page-cell.js"></script>
    <script src="library/minitel/vram.js"></script>
    <script src="library/minitel/vdu-cursor.js"></script>
    <script src="library/minitel/vdu.js"></script>
    <script src="library/minitel/decoder.js"></script>
    <script src="library/minitel/keyboard.js"></script>
    <script src="library/minitel/minitel-emulator.js"></script>
    <script src="library/minitel/start-emulators.js"></script>

    <script src="app/minitel.js"></script>

    <script>
      // Global variable to track which tab is active
      window.minitelTabActive = true;

      // Tab switching functionality
      const minitelTab = document.getElementById('minitel-tab');
      const editorTab = document.getElementById('editor-tab');
      const minitelView = document.getElementById('minitel-view');
      const editorView = document.getElementById('editor-view');

      function showMinitelTab() {
        minitelView.classList.add('active');
        editorView.classList.remove('active');
        minitelTab.classList.add('active');
        editorTab.classList.remove('active');
        window.minitelTabActive = true;
      }

      function showEditorTab() {
        minitelView.classList.remove('active');
        editorView.classList.add('active');
        minitelTab.classList.remove('active');
        editorTab.classList.add('active');
        window.minitelTabActive = false;
        // Force CodeMirror to refresh its layout and focus the editor
        setTimeout(() => {
          editor.refresh();
          editor.focus();
        }, 0);
      }

      minitelTab.addEventListener('click', showMinitelTab);
      editorTab.addEventListener('click', showEditorTab);

      // Initialize CodeMirror editor
      const editor = CodeMirror(document.getElementById('code-editor'), {
        mode: 'basic',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        autofocus: false
      });

      // Set initial placeholder text
      editor.setValue('10 PRINT "Hello BASTOS!"\n20 END');

      // Upload button functionality
      document.getElementById('upload-btn').addEventListener('click', function() {
        const filename = document.getElementById('filename').value || 'edit.bas';
        const code = editor.getValue();

        fetch(`/bastos/${filename}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: code
        })
        .then(response => {
          if (response.ok) {
            alert(`File '${filename}' uploaded successfully!`);
          } else {
            alert(`Error uploading file: ${response.status} ${response.statusText}`);
          }
        })
        .catch(error => {
          alert(`Error uploading file: ${error.message}`);
        });
      });
    </script>

  </body>
</html>
