
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>BASTOS - ÉDI</title>
    <link rel="stylesheet" href="css/minitel-keyboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css" />
	<meta name="author" content="Alain Basty" />
    <meta name="keywords" content="minitel, vintage, technologie, videotex, basic, programmation" />
    <meta name="description" content="Développez des applications BASTOS (Basic) pour Minitel" />

    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .navbar {
        background-color: #333;
        padding: 0;
        display: flex;
        align-items: center;
        height: 50px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        display: block;
        transition: background-color 0.3s;
        cursor: pointer;
        user-select: none;
      }
      .navbar a:hover {
        background-color: #555;
      }
      .navbar a.active {
        background-color: #4CAF50;
      }
      .container {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 10px;
        gap: 10px;
      }
      .tab-content {
        flex: 1;
        display: none;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }
      .tab-content.active {
        display: flex;
      }
      .minitel-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .code-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        height: 100%;
      }
      .bottombar {
        background-color: #333;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .bottombar label {
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        white-space: nowrap;
      }
      .bottombar input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        min-width: 150px;
      }
      .bottombar input[readonly] {
        background-color: #444;
        color: #ccc;
        cursor: default;
        border: 1px solid #555;
      }
      .filename-display {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .bottombar button {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .bottombar button:hover {
        background-color: #45a049;
      }
      #code-editor {
        flex: 1;
        height: 100%;
      }
      .CodeMirror {
        height: 100% !important;
        width: 100% !important;
      }
      .status-display {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }
      .status-icon {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      .status-icon.modified {
        background-color: #ff9800;
      }
      .status-icon.sent {
        background-color: #4CAF50;
      }
    </style>
  </head>
  <body>

    <div class="navbar">
      <a id="minitel-tab" class="active">Visionneuse Minitel</a>
      <a id="files-tab">Fichiers</a>
      <a id="editor-tab">Éditeur de Code</a>
    </div>

    <div class="container">
      <!-- Minitel Viewer Tab -->
      <div id="minitel-view" class="tab-content active">
        <div class="minitel-wrapper">
          <x-minitel data-socket="ws://localhost:1967" data-speed="4800" data-color="false">
        <canvas class="minitel-screen" data-minitel="screen"></canvas>
        <canvas class="minitel-cursor" data-minitel="cursor"></canvas>
        <import src="import/minitel-keyboard.html"></import>
        <audio class="minitel-beep" data-minitel="beep">
            <source src="sound/minitel-bip.mp3" type="audio/mpeg"/>
            Too bad, your browser does not support HTML5 audio or mp3 format.
        </audio>
      </x-minitel>
        </div>
      </div>

      <!-- Code Editor Tab -->
      <div id="editor-view" class="tab-content">
        <div class="code-section">
          <div id="code-editor"></div>
        </div>
        <div class="bottombar">
          <button id="upload-btn">Envoyer</button>
          <button id="run-btn">Exécuter...</button>
          <div class="filename-display">
            <span id="filename" style="color: white; font-family: Arial, sans-serif; font-size: 12px; font-weight: bold;">edit.bas</span>
            <div class="status-display">
              <span class="status-icon modified"></span>
              <span id="status-text">Modifié</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Files Tab -->
      <div id="files-view" class="tab-content">
        <div style="flex: 1; overflow-y: auto; padding: 10px;">
          <div id="files-list" style="color: white; font-family: Arial, sans-serif; font-size: 14px;">
            <p>GET /disk</p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/basic/basic.min.js"></script>
    <script src="library/generichelper/generichelper.js"></script>
    <script src="library/import-html/import-html.js"></script>
    <script src="library/autocallback/autocallback.js"></script>
    <script src="library/query-parameters/query-parameters.js"></script>
    <script src="library/finite-stack/finite-stack.js"></script>
    <script src="library/key-simulator/key-simulator.js"></script>
    <script src="library/settings-suite/settings-suite.js"></script>
    <script src="library/minitel/constant.js"></script>
    <script src="library/minitel/protocol.js"></script>
    <script src="library/minitel/elements.js"></script>
    <script src="library/minitel/text-grid.js"></script>
    <script src="library/minitel/char-size.js"></script>
    <script src="library/minitel/font-sprite.js"></script>
    <script src="library/minitel/page-cell.js"></script>
    <script src="library/minitel/vram.js"></script>
    <script src="library/minitel/vdu-cursor.js"></script>
    <script src="library/minitel/vdu.js"></script>
    <script src="library/minitel/decoder.js"></script>
    <script src="library/minitel/keyboard.js"></script>
    <script src="library/minitel/minitel-emulator.js"></script>
    <script src="library/minitel/start-emulators.js"></script>

    <script src="app/minitel.js"></script>

    <script>
      // Global variable to track which tab is active
      window.minitelTabActive = true;

      // Tab switching functionality
      const minitelTab = document.getElementById('minitel-tab');
      const editorTab = document.getElementById('editor-tab');
      const filesTab = document.getElementById('files-tab');
      const minitelView = document.getElementById('minitel-view');
      const editorView = document.getElementById('editor-view');
      const filesView = document.getElementById('files-view');

      function showMinitelTab() {
        minitelView.classList.add('active');
        editorView.classList.remove('active');
        filesView.classList.remove('active');
        minitelTab.classList.add('active');
        editorTab.classList.remove('active');
        filesTab.classList.remove('active');
        window.minitelTabActive = true;
      }

      function showEditorTab() {
        minitelView.classList.remove('active');
        editorView.classList.add('active');
        filesView.classList.remove('active');
        minitelTab.classList.remove('active');
        editorTab.classList.add('active');
        filesTab.classList.remove('active');
        window.minitelTabActive = false;
        // Force CodeMirror to refresh its layout and focus the editor
        setTimeout(() => {
          editor.refresh();
          editor.focus();
        }, 0);
      }

      function showFilesTab() {
        minitelView.classList.remove('active');
        editorView.classList.remove('active');
        filesView.classList.add('active');
        minitelTab.classList.remove('active');
        editorTab.classList.remove('active');
        filesTab.classList.add('active');
        window.minitelTabActive = false;
        // Load files list when tab is shown
        loadFilesList();
      }

      minitelTab.addEventListener('click', showMinitelTab);
      editorTab.addEventListener('click', showEditorTab);
      filesTab.addEventListener('click', showFilesTab);

      // Initialize CodeMirror editor
      const editor = CodeMirror(document.getElementById('code-editor'), {
        mode: 'basic',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        autofocus: false
      });

      // Set initial placeholder text
      editor.setValue('10 PRINT "Bonjour BASTOS !"\n20 END');
      // Status display management
      let updateStatus = function(status) {
        const statusIcon = document.querySelector('.status-icon');
        const statusText = document.getElementById('status-text');

        if (status === 'modified') {
          statusIcon.className = 'status-icon modified';
          statusText.textContent = 'Modifié';
        } else if (status === 'sent') {
          statusIcon.className = 'status-icon sent';
          statusText.textContent = 'Envoyé';
        }
      };

      // Track editor changes
      editor.on('change', function() {
        updateStatus('modified');
      });

      // Function to send text through Minitel keyboard
      let sendToMinitelKeyboard = function(text) {
        return new Promise((resolve) => {
          let index = 0;

          const sendNextChar = () => {
            if (index >= text.length) {
              resolve();
              return;
            }

            const char = text[index];
            // The keyboard listens to these events
            if (char === '\n') {
                const keypressEvent = new KeyboardEvent('keypress', {
                key: "Enter",
                charCode: 13,
                keyCode: 13,
                bubbles: true,
                cancelable: true
              });
              document.dispatchEvent(keypressEvent);
            } else {
              // For regular characters, dispatch keypress
              const keypressEvent = new KeyboardEvent('keypress', {
                key: char,
                charCode: char.charCodeAt(0),
                keyCode: char.charCodeAt(0),
                bubbles: true,
                cancelable: true
              });
              document.dispatchEvent(keypressEvent);
            }
            index++;

            // Small delay between key events (50ms)
            setTimeout(sendNextChar, 50);
          };

          sendNextChar();
        });
      };

      // Upload button functionality
      const uploadBtn = document.getElementById('upload-btn');

      // Function to upload code if needed
      let uploadCode = function() {
        return new Promise((resolve, reject) => {
          const status = document.getElementById('status-text').textContent;

          // If already sent, no need to upload
          if (status === 'Envoyé') {
            resolve();
            return;
          }

          const filename = document.getElementById('filename').value || 'edit.bas';
          let code = editor.getValue();
          // Add trailing newline if not present
          if (!code.endsWith('\n')) {
            code += '\n';
          }

          // Use the display filename
          const displayFilename = document.getElementById('filename').textContent;
          fetch(`/bastos/${displayFilename}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'text/plain'
            },
            body: code
          })
          .then(response => {
            if (response.ok) {
              updateStatus('sent');
              resolve();
            } else {
              alert(`Erreur lors de l'envoi du fichier : ${response.status} ${response.statusText}`);
              reject();
            }
          })
          .catch(error => {
            alert(`Erreur lors de l'envoi du fichier : ${error.message}`);
            reject();
          });
        });
      };

      uploadBtn.addEventListener('click', function() {
        uploadCode();
      });

      // Run button functionality
      const runBtn = document.getElementById('run-btn');
      runBtn.addEventListener('click', async function() {
        try {
          // Upload code if modified
          await uploadCode();

          // Switch to Minitel tab
          showMinitelTab();

          // Get the filename
          const filename = document.getElementById('filename').textContent || 'edit.bas';

          // Create the run command string with newline
          const runCommand = `run"${filename}"\n`;

          // Wait a bit for tab switch animation
          setTimeout(() => {
            // Send run command through Minitel keyboard
            sendToMinitelKeyboard(runCommand);
          }, 200);

        } catch (error) {
          // Error already handled in uploadCode()
        }
      });

      // Ctrl+S keyboard shortcut for upload
      document.addEventListener('keydown', function(event) {
        if ((event.ctrlKey || event.metaKey) && event.key === 's') {
          event.preventDefault();
          uploadBtn.click();
        }
      });

      // Files tab functionality
      function loadFilesList() {
        const filesList = document.getElementById('files-list');
        filesList.innerHTML = '<p style="color: #999;">Chargement des fichiers...</p>';

        fetch('http://localhost:9000/disk')
          .then(response => response.text())
          .then(html => {
            // Parse HTML to extract filenames
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Try to find all links in the response
            const links = doc.querySelectorAll('a');
            const files = [];

            links.forEach(link => {
              const href = link.getAttribute('href');
              // Filter out parent directory and other navigation links, only include .txt and .bas files
              if (href && href !== '/' && href !== '../' && !href.startsWith('?') && href !== '' && (href.endsWith('.txt') || href.endsWith('.bas'))) {
                const filename = href.replace(/\/$/, ''); // Remove trailing slash
                if (filename && !files.includes(filename)) {
                  files.push(filename);
                }
              }
            });

            if (files.length === 0) {
              filesList.innerHTML = '<p style="color: #999;">Aucun fichier trouvé.</p>';
              return;
            }

            // Sort files alphabetically
            files.sort();

            // Build HTML for file list
            let fileListHtml = '';
            files.forEach(file => {
              fileListHtml += `<a href="#" data-filename="${file}" style="display: block; color: #4CAF50; text-decoration: none; padding: 8px 0; cursor: pointer; transition: color 0.3s;">${file}</a>`;
            });
            filesList.innerHTML = fileListHtml;

            // Add click handlers to file links
            filesList.querySelectorAll('a').forEach(link => {
              link.addEventListener('click', function(e) {
                e.preventDefault();
                const filename = this.getAttribute('data-filename');
                downloadAndLoadFile(filename);
              });
              link.addEventListener('mouseover', function() {
                this.style.color = '#45a049';
                this.style.textDecoration = 'underline';
              });
              link.addEventListener('mouseout', function() {
                this.style.color = '#4CAF50';
                this.style.textDecoration = 'none';
              });
            });
          })
          .catch(error => {
            filesList.innerHTML = `<p style="color: #ff6b6b;">Erreur lors du chargement des fichiers: ${error.message}</p>`;
          });
      }

      function downloadAndLoadFile(filename) {
        fetch(`http://localhost:9000/disk/${filename}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(content => {
            // Load content into editor
            editor.setValue(content);
            // Update filename display
            document.getElementById('filename').textContent = filename;
            // Reset status to modified
            updateStatus('modified');
            // Switch to editor tab
            showEditorTab();
          })
          .catch(error => {
            alert(`Erreur lors du téléchargement du fichier: ${error.message}`);
          });
      }
    </script>

  </body>
</html>
