
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>BASTOS - √âDI</title>
    <link rel="stylesheet" href="css/minitel-keyboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css" />
	<meta name="author" content="Alain Basty" />
    <meta name="keywords" content="minitel, vintage, technologie, videotex, basic, programmation" />
    <meta name="description" content="D√©veloppez des applications BASTOS (Basic) pour Minitel" />

    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .navbar {
        background-color: #333;
        padding: 0;
        display: flex;
        align-items: center;
        height: 50px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        display: block;
        transition: background-color 0.3s;
        cursor: pointer;
        user-select: none;
      }
      .navbar a:hover {
        background-color: #555;
      }
      .navbar a.active {
        background-color: #4CAF50;
      }
      .container {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 10px;
        gap: 10px;
      }
      .tab-content {
        flex: 1;
        display: none;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }
      .tab-content.active {
        display: flex;
      }
      .minitel-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .code-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        height: 100%;
      }
      .bottombar {
        background-color: #333;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
      }
      .bottombar label {
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        white-space: nowrap;
      }
      .bottombar input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        min-width: 150px;
      }
      .bottombar input[readonly] {
        background-color: #444;
        color: #ccc;
        cursor: default;
        border: 1px solid #555;
      }
      .filename-display {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .bottombar button {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .bottombar button:hover {
        background-color: #45a049;
      }
      #code-editor {
        flex: 1;
        height: 100%;
      }
      .CodeMirror {
        height: 100% !important;
        width: 100% !important;
      }
      .status-display {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }
      .status-icon {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      .status-icon.modified {
        background-color: #ff9800;
      }
      .status-icon.sent {
        background-color: #4CAF50;
      }
      .files-list-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background-color: #444;
        border-radius: 4px;
        transition: background-color 0.3s;
        gap: 10px;
      }
      .file-item:hover {
        background-color: #555;
      }
      .file-name {
        flex: 1;
        color: #4CAF50;
        cursor: pointer;
        text-decoration: none;
        font-family: monospace;
        font-size: 14px;
        word-break: break-all;
        transition: color 0.3s;
      }
      .file-name:hover {
        color: #45a049;
      }
      .file-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }
      .file-action-btn {
        padding: 6px 10px;
        background-color: #555;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
      }
      .file-action-btn:hover {
        background-color: #666;
      }
      .file-action-btn.edit {
        background-color: #2196F3;
      }
      .file-action-btn.edit:hover {
        background-color: #0b7dda;
      }
      .file-action-btn.delete {
        background-color: #f44336;
      }
      .file-action-btn.delete:hover {
        background-color: #da190b;
      }
      .file-action-btn.run {
        background-color: #4CAF50;
      }
      .file-action-btn.run:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>

    <div class="navbar">
      <a id="minitel-tab" class="active">Visionneuse Minitel</a>
      <a id="files-tab">Fichiers</a>
      <a id="editor-tab">√âditeur de Code</a>
    </div>

    <div class="container">
      <!-- Minitel Viewer Tab -->
      <div id="minitel-view" class="tab-content active">
        <div class="minitel-wrapper">
          <x-minitel data-socket="ws://localhost:1967" data-speed="4800" data-color="false">
        <canvas class="minitel-screen" data-minitel="screen"></canvas>
        <canvas class="minitel-cursor" data-minitel="cursor"></canvas>
        <import src="import/minitel-keyboard.html"></import>
        <audio class="minitel-beep" data-minitel="beep">
            <source src="sound/minitel-bip.mp3" type="audio/mpeg"/>
            Too bad, your browser does not support HTML5 audio or mp3 format.
        </audio>
      </x-minitel>
        </div>
      </div>

      <!-- Code Editor Tab -->
      <div id="editor-view" class="tab-content">
        <div class="code-section">
          <div id="code-editor"></div>
        </div>
        <div class="bottombar">
          <button id="new-btn">Nouveau</button>
          <button id="upload-btn">Envoyer</button>
          <button id="run-btn">Ex√©cuter...</button>
          <div class="filename-display">
            <span id="filename" style="color: white; font-family: Arial, sans-serif; font-size: 12px; font-weight: bold;">edit.bas</span>
            <div class="status-display">
              <span class="status-icon modified"></span>
              <span id="status-text">Modifi√©</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Files Tab -->
      <div id="files-view" class="tab-content">
        <div style="flex: 1; overflow-y: auto; padding: 10px;">
          <div id="files-list" style="color: white; font-family: Arial, sans-serif; font-size: 14px;">
            <p>GET /disk</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filename dialog -->
    <dialog id="filename-dialog" style="border: none; border-radius: 8px; background-color: #333; color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <h2 style="margin-top: 0; margin-bottom: 15px;">Nom du fichier</h2>
      <p style="margin-bottom: 15px;">Entrez le nom du fichier :</p>
      <input type="text" id="filename-input" placeholder="edit.bas" value="edit.bas" style="width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #555; border-radius: 4px; background-color: #444; color: white; font-family: Arial, sans-serif; box-sizing: border-box;" />
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="filename-cancel" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Annuler</button>
        <button id="filename-ok" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">OK</button>
      </div>
    </dialog>

    <!-- New file confirmation dialog -->
    <dialog id="new-confirm-dialog" style="border: none; border-radius: 8px; background-color: #333; color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <h2 style="margin-top: 0; margin-bottom: 15px;">Fichier modifi√©</h2>
      <p style="margin-bottom: 20px;">Le fichier a √©t√© modifi√©. Que voulez-vous faire ?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="new-cancel" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Annuler</button>
        <button id="new-clear-only" style="padding: 8px 16px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Juste Effacer</button>
        <button id="new-upload-clear" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">T√©l√©charger & Effacer</button>
      </div>
    </dialog>

    <!-- Upload failed confirmation dialog -->
    <dialog id="upload-failed-dialog" style="border: none; border-radius: 8px; background-color: #333; color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <h2 style="margin-top: 0; margin-bottom: 15px;">Erreur d'upload</h2>
      <p style="margin-bottom: 20px;">L'upload a √©chou√©. Voulez-vous effacer quand m√™me ?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="upload-failed-cancel" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Annuler</button>
        <button id="upload-failed-clear" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Effacer</button>
      </div>
    </dialog>

    <!-- Delete confirmation dialog -->
    <dialog id="delete-confirm-dialog" style="border: none; border-radius: 8px; background-color: #333; color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <h2 style="margin-top: 0; margin-bottom: 15px;">Supprimer le fichier</h2>
      <p style="margin-bottom: 20px;" id="delete-confirm-message">√ätes-vous s√ªr de vouloir supprimer ce fichier ?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="delete-confirm-cancel" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Annuler</button>
        <button id="delete-confirm-ok" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Supprimer</button>
      </div>
    </dialog>

    <!-- Delete error dialog -->
    <dialog id="delete-error-dialog" style="border: none; border-radius: 8px; background-color: #333; color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <h2 style="margin-top: 0; margin-bottom: 15px;">Erreur de suppression</h2>
      <p style="margin-bottom: 20px;" id="delete-error-message">Une erreur s'est produite lors de la suppression du fichier.</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="delete-error-ok" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">OK</button>
      </div>
    </dialog>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/basic/basic.min.js"></script>
    <script src="library/generichelper/generichelper.js"></script>
    <script src="library/import-html/import-html.js"></script>
    <script src="library/autocallback/autocallback.js"></script>
    <script src="library/query-parameters/query-parameters.js"></script>
    <script src="library/finite-stack/finite-stack.js"></script>
    <script src="library/key-simulator/key-simulator.js"></script>
    <script src="library/settings-suite/settings-suite.js"></script>
    <script src="library/minitel/constant.js"></script>
    <script src="library/minitel/protocol.js"></script>
    <script src="library/minitel/elements.js"></script>
    <script src="library/minitel/text-grid.js"></script>
    <script src="library/minitel/char-size.js"></script>
    <script src="library/minitel/font-sprite.js"></script>
    <script src="library/minitel/page-cell.js"></script>
    <script src="library/minitel/vram.js"></script>
    <script src="library/minitel/vdu-cursor.js"></script>
    <script src="library/minitel/vdu.js"></script>
    <script src="library/minitel/decoder.js"></script>
    <script src="library/minitel/keyboard.js"></script>
    <script src="library/minitel/minitel-emulator.js"></script>
    <script src="library/minitel/start-emulators.js"></script>

    <script src="app/minitel.js"></script>

    <script>
      // Global variable to track which tab is active
      window.minitelTabActive = true;

      // Tab switching functionality
      const minitelTab = document.getElementById('minitel-tab');
      const editorTab = document.getElementById('editor-tab');
      const filesTab = document.getElementById('files-tab');
      const minitelView = document.getElementById('minitel-view');
      const editorView = document.getElementById('editor-view');
      const filesView = document.getElementById('files-view');

      function showMinitelTab() {
        minitelView.classList.add('active');
        editorView.classList.remove('active');
        filesView.classList.remove('active');
        minitelTab.classList.add('active');
        editorTab.classList.remove('active');
        filesTab.classList.remove('active');
        window.minitelTabActive = true;
      }

      function showEditorTab() {
        minitelView.classList.remove('active');
        editorView.classList.add('active');
        filesView.classList.remove('active');
        minitelTab.classList.remove('active');
        editorTab.classList.add('active');
        filesTab.classList.remove('active');
        window.minitelTabActive = false;
        // Force CodeMirror to refresh its layout and focus the editor
        setTimeout(() => {
          editor.refresh();
          editor.focus();
        }, 0);
      }

      function showFilesTab() {
        minitelView.classList.remove('active');
        editorView.classList.remove('active');
        filesView.classList.add('active');
        minitelTab.classList.remove('active');
        editorTab.classList.remove('active');
        filesTab.classList.add('active');
        window.minitelTabActive = false;
        // Load files list when tab is shown
        loadFilesList();
      }

      minitelTab.addEventListener('click', showMinitelTab);
      editorTab.addEventListener('click', showEditorTab);
      filesTab.addEventListener('click', showFilesTab);

      // Initialize CodeMirror editor
      const editor = CodeMirror(document.getElementById('code-editor'), {
        mode: 'basic',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        autofocus: false
      });

      // Status display management
      let updateStatus = function(status) {
        const statusIcon = document.querySelector('.status-icon');
        const statusText = document.getElementById('status-text');

        if (status === 'modified') {
          statusIcon.className = 'status-icon modified';
          statusText.textContent = 'Modifi√©';
        } else if (status === 'sent') {
          statusIcon.className = 'status-icon sent';
          statusText.textContent = 'Envoy√©';
        }
      };

      // Set initial placeholder text
      editor.setValue('');
      // Set initial status to sent
      updateStatus('sent');
      // Clear initial filename
      document.getElementById('filename').textContent = '';

      // Track editor changes
      editor.on('change', function() {
        updateStatus('modified');
      });

      // Function to send text through Minitel keyboard
      let sendToMinitelKeyboard = function(text) {
        return new Promise((resolve) => {
          let index = 0;

          const sendNextChar = () => {
            if (index >= text.length) {
              resolve();
              return;
            }

            const char = text[index];
            // The keyboard listens to these events
            if (char === '\n') {
                const keypressEvent = new KeyboardEvent('keypress', {
                key: "Enter",
                charCode: 13,
                keyCode: 13,
                bubbles: true,
                cancelable: true
              });
              document.dispatchEvent(keypressEvent);
            } else {
              // For regular characters, dispatch keypress
              const keypressEvent = new KeyboardEvent('keypress', {
                key: char,
                charCode: char.charCodeAt(0),
                keyCode: char.charCodeAt(0),
                bubbles: true,
                cancelable: true
              });
              document.dispatchEvent(keypressEvent);
            }
            index++;

            // Small delay between key events (50ms)
            setTimeout(sendNextChar, 50);
          };

          sendNextChar();
        });
      };

      // Upload button functionality
      const uploadBtn = document.getElementById('upload-btn');

      // Function to prompt for filename if empty using dialog
      let ensureFilename = function() {
        return new Promise((resolve) => {
          const currentFilename = document.getElementById('filename').textContent.trim();
          if (currentFilename) {
            resolve(currentFilename);
            return;
          }

          // Show filename dialog
          const dialog = document.getElementById('filename-dialog');
          const input = document.getElementById('filename-input');
          const cancelBtn = document.getElementById('filename-cancel');
          const okBtn = document.getElementById('filename-ok');

          // Set focus on input and select text
          input.focus();
          input.select();

          // Handle OK button
          const handleOk = () => {
            const newFilename = input.value.trim();
            if (newFilename) {
              document.getElementById('filename').textContent = newFilename;
              dialog.close();
              resolve(newFilename);
            } else {
              alert('Le nom du fichier ne peut pas √™tre vide.');
            }
          };

          // Handle Cancel button
          const handleCancel = () => {
            dialog.close();
            resolve(null);
          };

          // Handle Enter key
          const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
              handleOk();
            } else if (e.key === 'Escape') {
              handleCancel();
            }
          };

          okBtn.addEventListener('click', handleOk);
          cancelBtn.addEventListener('click', handleCancel);
          input.addEventListener('keydown', handleKeyDown);

          dialog.showModal();

          // Cleanup listeners when dialog closes
          dialog.addEventListener('close', () => {
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            input.removeEventListener('keydown', handleKeyDown);
          }, { once: true });
        });
      };

      // Function to upload code if needed
      let uploadCode = function() {
        return new Promise(async (resolve, reject) => {
          // Ensure filename is set
          const filename = await ensureFilename();
          if (!filename) {
            reject();
            return;
          }

          const status = document.getElementById('status-text').textContent;

          // If already sent, no need to upload
          if (status === 'Envoy√©') {
            resolve();
            return;
          }

          let code = editor.getValue();
          // Add trailing newline if not present
          if (!code.endsWith('\n')) {
            code += '\n';
          }

          // Use the display filename
          const displayFilename = document.getElementById('filename').textContent;
          fetch(`/bastos/${displayFilename}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'text/plain'
            },
            body: code
          })
          .then(response => {
            if (response.ok) {
              updateStatus('sent');
              resolve();
            } else {
              alert(`Erreur lors de l'envoi du fichier : ${response.status} ${response.statusText}`);
              reject();
            }
          })
          .catch(error => {
            alert(`Erreur lors de l'envoi du fichier : ${error.message}`);
            reject();
          });
        });
      };

      uploadBtn.addEventListener('click', function() {
        uploadCode();
      });

      // Run button functionality
      const runBtn = document.getElementById('run-btn');
      runBtn.addEventListener('click', async function() {
        try {
          // Ensure filename is set
          const filename = await ensureFilename();
          if (!filename) {
            return;
          }

          // Upload code if modified
          await uploadCode();

          // Switch to Minitel tab
          showMinitelTab();

          // Get the filename
          const runFilename = document.getElementById('filename').textContent || 'edit.bas';

          // Create the run command string with newline
          const runCommand = `run"${runFilename}"\n`;

          // Wait a bit for tab switch animation
          setTimeout(() => {
            // Send run command through Minitel keyboard
            sendToMinitelKeyboard(runCommand);
          }, 200);

        } catch (error) {
          // Error already handled in uploadCode()
        }
      });

      // New button functionality
      const newBtn = document.getElementById('new-btn');
      newBtn.addEventListener('click', function() {
        const status = document.getElementById('status-text').textContent;

        // Helper function to clear editor
        const clearEditor = function() {
          editor.setValue('');
          document.getElementById('filename').textContent = '';
          updateStatus('sent');
        };

        if (status === 'Modifi√©') {
          // Show confirmation dialog
          const dialog = document.getElementById('new-confirm-dialog');
          const cancelBtn = document.getElementById('new-cancel');
          const clearOnlyBtn = document.getElementById('new-clear-only');
          const uploadClearBtn = document.getElementById('new-upload-clear');

          // Handle Cancel button
          const handleCancel = () => {
            dialog.close();
          };

          // Handle Clear Only button
          const handleClearOnly = () => {
            dialog.close();
            clearEditor();
          };

          // Handle Upload & Clear button
          const handleUploadClear = async () => {
            dialog.close();
            try {
              await uploadCode();
              clearEditor();
            } catch (error) {
              // Upload failed, ask if user wants to clear anyway using dialog
              const failedDialog = document.getElementById('upload-failed-dialog');
              const failedCancelBtn = document.getElementById('upload-failed-cancel');
              const failedClearBtn = document.getElementById('upload-failed-clear');

              const handleFailedCancel = () => {
                failedDialog.close();
              };

              const handleFailedClear = () => {
                failedDialog.close();
                clearEditor();
              };

              failedCancelBtn.addEventListener('click', handleFailedCancel);
              failedClearBtn.addEventListener('click', handleFailedClear);

              failedDialog.showModal();

              // Cleanup listeners when dialog closes
              failedDialog.addEventListener('close', () => {
                failedCancelBtn.removeEventListener('click', handleFailedCancel);
                failedClearBtn.removeEventListener('click', handleFailedClear);
              }, { once: true });
            }
          };

          cancelBtn.addEventListener('click', handleCancel);
          clearOnlyBtn.addEventListener('click', handleClearOnly);
          uploadClearBtn.addEventListener('click', handleUploadClear);

          dialog.showModal();

          // Cleanup listeners when dialog closes
          dialog.addEventListener('close', () => {
            cancelBtn.removeEventListener('click', handleCancel);
            clearOnlyBtn.removeEventListener('click', handleClearOnly);
            uploadClearBtn.removeEventListener('click', handleUploadClear);
          }, { once: true });
        } else {
          // If status is already 'Envoy√©', just clear
          clearEditor();
        }
      });

      // Ctrl+S keyboard shortcut for upload
      document.addEventListener('keydown', function(event) {
        if ((event.ctrlKey || event.metaKey) && event.key === 's') {
          event.preventDefault();
          uploadBtn.click();
        }
      });

      // Files tab functionality
      function loadFilesList() {
        const filesList = document.getElementById('files-list');
        filesList.innerHTML = '<p style="color: #999;">Chargement des fichiers...</p>';

        fetch('http://localhost:9000/disk')
          .then(response => response.text())
          .then(html => {
            // Parse HTML to extract filenames
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Try to find all links in the response
            const links = doc.querySelectorAll('a');
            const files = [];

            links.forEach(link => {
              const href = link.getAttribute('href');
              // Filter out parent directory and other navigation links, only include .txt and .bas files
              if (href && href !== '/' && href !== '../' && !href.startsWith('?') && href !== '' && (href.endsWith('.txt') || href.endsWith('.bas'))) {
                const filename = href.replace(/\/$/, ''); // Remove trailing slash
                if (filename && !files.includes(filename)) {
                  files.push(filename);
                }
              }
            });

            if (files.length === 0) {
              filesList.innerHTML = '<p style="color: #999;">Aucun fichier trouv√©.</p>';
              return;
            }

            // Sort files alphabetically
            files.sort();

            // Build HTML for file list with new layout
            let fileListHtml = '<div class="files-list-container">';
            files.forEach(file => {
              fileListHtml += `
                <div class="file-item">
                  <div class="file-name" data-filename="${file}">${file}</div>
                  <div class="file-actions">
                    <button class="file-action-btn edit" title="√âditer" data-filename="${file}" data-action="edit">‚úé</button>
                    <button class="file-action-btn run" title="Ex√©cuter" data-filename="${file}" data-action="run">‚ñ∂</button>
                    <button class="file-action-btn delete" title="Supprimer" data-filename="${file}" data-action="delete">üóë</button>
                  </div>
                </div>
              `;
            });
            fileListHtml += '</div>';
            filesList.innerHTML = fileListHtml;

            // Add click handlers to file names and edit buttons
            filesList.querySelectorAll('.file-name').forEach(link => {
              link.addEventListener('click', function(e) {
                e.preventDefault();
                const filename = this.getAttribute('data-filename');
                downloadAndLoadFile(filename);
              });
            });

            filesList.querySelectorAll('[data-action="edit"]').forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                const filename = this.getAttribute('data-filename');
                downloadAndLoadFile(filename);
              });
            });

            // Add click handlers to run buttons
            filesList.querySelectorAll('[data-action="run"]').forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                const filename = this.getAttribute('data-filename');
                runFileFromFilesList(filename);
              });
            });

            // Add click handlers to delete buttons
            filesList.querySelectorAll('[data-action="delete"]').forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                const filename = this.getAttribute('data-filename');
                showDeleteConfirmDialog(filename);
              });
            });
          })
          .catch(error => {
            filesList.innerHTML = `<p style="color: #ff6b6b;">Erreur lors du chargement des fichiers: ${error.message}</p>`;
          });
      }

      function showDeleteConfirmDialog(filename) {
        const dialog = document.getElementById('delete-confirm-dialog');
        const message = document.getElementById('delete-confirm-message');
        const cancelBtn = document.getElementById('delete-confirm-cancel');
        const okBtn = document.getElementById('delete-confirm-ok');

        message.textContent = `√ätes-vous s√ªr de vouloir supprimer "${filename}" ?`;

        const handleCancel = () => {
          dialog.close();
        };

        const handleDelete = () => {
          dialog.close();
          deleteFile(filename);
        };

        cancelBtn.addEventListener('click', handleCancel);
        okBtn.addEventListener('click', handleDelete);

        dialog.showModal();

        // Cleanup listeners when dialog closes
        dialog.addEventListener('close', () => {
          cancelBtn.removeEventListener('click', handleCancel);
          okBtn.removeEventListener('click', handleDelete);
        }, { once: true });
      }

      function deleteFile(filename) {
        fetch(`/bastos/${filename}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (response.ok) {
              // File deleted successfully, reload the list
              loadFilesList();
            } else {
              showDeleteErrorDialog(`Erreur ${response.status}: ${response.statusText}`);
            }
          })
          .catch(error => {
            showDeleteErrorDialog(error.message);
          });
      }

      function showDeleteErrorDialog(errorMessage) {
        const dialog = document.getElementById('delete-error-dialog');
        const message = document.getElementById('delete-error-message');
        const okBtn = document.getElementById('delete-error-ok');

        message.textContent = `Erreur lors de la suppression du fichier: ${errorMessage}`;

        const handleOk = () => {
          dialog.close();
        };

        okBtn.addEventListener('click', handleOk);
        dialog.showModal();

        // Cleanup listeners when dialog closes
        dialog.addEventListener('close', () => {
          okBtn.removeEventListener('click', handleOk);
        }, { once: true });
      }

      function runFileFromFilesList(filename) {
        // Switch to Minitel tab
        showMinitelTab();

        // Create the run command string with newline
        const runCommand = `run"${filename}"\n`;

        // Wait a bit for tab switch animation
        setTimeout(() => {
          // Send run command through Minitel keyboard
          sendToMinitelKeyboard(runCommand);
        }, 200);
      }

      function downloadAndLoadFile(filename) {
        fetch(`http://localhost:9000/disk/${filename}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(content => {
            // Load content into editor
            editor.setValue(content);
            // Update filename display
            document.getElementById('filename').textContent = filename;
            // Set status to sent (file from disk)
            updateStatus('sent');
            // Switch to editor tab
            showEditorTab();
          })
          .catch(error => {
            alert(`Erreur lors du t√©l√©chargement du fichier: ${error.message}`);
          });
      }
    </script>

  </body>
</html>
